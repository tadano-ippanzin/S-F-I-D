<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Scratch Follower Icon Downloader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 40px auto; text-align: center; background: #f0f0f0; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input { padding: 10px; width: 60%; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; cursor: pointer; background: #4D97FF; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:disabled { background: #ccc; }
        #status { margin-top: 20px; color: #555; font-size: 0.9em; white-space: pre-line; }
        .progress-bar { height: 10px; background: #eee; border-radius: 5px; margin-top: 10px; overflow: hidden; display: none; }
        #progress-inner { height: 100%; background: #4D97FF; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="card">
    <h1>Scratch Icons Downloader</h1>
    <p>å…¨ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è§£æã—ã¦ZIPã«ã¾ã¨ã‚ã¾ã™</p>
    
    <div class="input-group">
        <input type="text" id="username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ› (ä¾‹: griffpatch)">
        <button id="startBtn">é–‹å§‹</button>
    </div>

    <div class="progress-container" id="progressContainer">
        <div id="progress-bar"></div>
    </div>
    <div id="status">å¾…æ©Ÿä¸­...</div>
</div>

<script>
const startBtn = document.getElementById('startBtn');
const status = document.getElementById('status');
const progressBar = document.getElementById('progress-bar');
const progressContainer = document.getElementById('progressContainer');

const sleep = ms => new Promise(res => setTimeout(res, ms));

// ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã®Fetch
async function fetchViaProxy(url) {
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const response = await fetch(proxyUrl);
    if (!response.ok) throw new Error("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    return await response.json();
}

startBtn.onclick = async () => {
    const user = document.getElementById('username').value.trim();
    if (!user) return alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

    // UIåˆæœŸåŒ–
    startBtn.disabled = true;
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    
    const zip = new JSZip();
    let allFollowers = [];
    let offset = 0;
    const limit = 40;

    try {
        // --- STEP 1: ãƒªã‚¹ãƒˆå–å¾— ---
        while (true) {
            status.innerText = `åç°¿ã‚’å–å¾—ä¸­... (${offset}äººç›®ã€œ)`;
            const dataWrap = await fetchViaProxy(`https://api.scratch.mit.edu/users/${user}/followers?limit=${limit}&offset=${offset}`);
            const data = JSON.parse(dataWrap.contents);

            if (!data || data.length === 0) break;
            allFollowers = allFollowers.concat(data);
            offset += limit;
            await sleep(100); // è² è·è»½æ¸›
        }

        if (allFollowers.length === 0) throw new Error("ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");

        // --- STEP 2: ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---
        for (let i = 0; i < allFollowers.length; i++) {
            const f = allFollowers[i];
            const iconUrl = f.profile.images['90x90'];
            
            status.innerText = `å–å¾—ä¸­ (${i + 1}/${allFollowers.length}): ${f.username}`;
            progressBar.style.width = `${((i + 1) / allFollowers.length) * 100}%`;

            try {
                // ç”»åƒã‚’ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§å–å¾—ï¼ˆbase64ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã£ã¦ãã‚‹ï¼‰
                const imgWrap = await fetchViaProxy(iconUrl);
                const blobRes = await fetch(imgWrap.contents);
                const blob = await blobRes.blob();

                // æ‹¡å¼µå­ã®åˆ¤åˆ¥
                let ext = "png";
                if (blob.type === "image/webp") ext = "webp";
                else if (blob.type === "image/jpeg") ext = "jpg";
                else if (blob.type === "image/gif") ext = "gif";

                zip.file(`${f.username}.${ext}`, blob);
            } catch (e) {
                console.error(`${f.username} ã®å–å¾—ã«å¤±æ•—`, e);
            }

            // å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’é¿ã‘ã‚‹ãŸã‚ã®å¾®å°ãªå¾…æ©Ÿ
            if (i % 5 === 0) await sleep(50);
        }

        // --- STEP 3: ZIPç”Ÿæˆ ---
        status.innerText = "ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...";
        const content = await zip.generateAsync({ type: "blob" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(content);
        link.download = `scratch_${user}_followers.zip`;
        link.click();

        status.innerText = `å®Œäº†ï¼ ${allFollowers.length}ä»¶ä¿å­˜ã—ã¾ã—ãŸã€‚`;
    } catch (err) {
        status.innerText = "ã‚¨ãƒ©ãƒ¼: " + err.message;
        console.error(err);
    } finally {
        startBtn.disabled = false;
    }
};
</script>

</body>
</html>
ğŸ› ï¸ æ”¹è‰¯ã®ãƒã‚¤ãƒ³ãƒˆ
æ‹¡å¼µå­ã®å‹•çš„åˆ¤å®š: blob.type ã‚’è¦‹ã¦ã€webp, png, jpg, gif ã‚’é©åˆ‡ã«æŒ¯ã‚Šåˆ†ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

å…¨ä»¶ãƒ«ãƒ¼ãƒ—: ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãŒ0äººã«ãªã‚‹ã¾ã§ offset ã‚’ãšã‚‰ã—ãªãŒã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ç¶šã‘ã¾ã™ã€‚

UIã®æ”¹å–„: ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’è¿½åŠ ã—ã€ä»Šèª°ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‡¦ç†ã—ã¦ã„ã‚‹ã‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¦‹ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

âš ï¸ æ³¨æ„äº‹é …
ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãŒ 5,000äºº ã‚’è¶…ãˆã‚‹ã‚ˆã†ãªè¶…äººæ°—ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ¢ãƒªï¼ˆRAMï¼‰ã‚’å¤§é‡ã«æ¶ˆè²»ã—ã€é€”ä¸­ã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯ã€ä¸€åº¦ã«è½ã¨ã™äººæ•°ã‚’åˆ¶é™ã™ã‚‹ã‹ã€Node.jsç‰ˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œï¼‰ã¸ã®åˆ‡ã‚Šæ›¿ãˆã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

ã¾ãšã¯ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã€ãŠæ‰‹å…ƒã®ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼å‹•ã‹ãªã‹ã£ãŸã‚‰ã¾ãŸæ•™ãˆã¦ãã ã•ã„ã­ã€‚
